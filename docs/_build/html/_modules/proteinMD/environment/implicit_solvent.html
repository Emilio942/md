<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>proteinMD.environment.implicit_solvent &#8212; ProteinMD 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <script src="../../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for proteinMD.environment.implicit_solvent</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implicit Solvent Model Implementation</span>

<span class="sd">This module implements the Generalized Born/Surface Area (GB/SA) implicit solvent model</span>
<span class="sd">for molecular dynamics simulations. The model provides significant computational speedup</span>
<span class="sd">over explicit solvation while maintaining accuracy for protein folding studies.</span>

<span class="sd">Key Components:</span>
<span class="sd">1. Generalized Born (GB) model for electrostatic solvation</span>
<span class="sd">2. Surface Area (SA) term for hydrophobic interactions</span>
<span class="sd">3. Optimized algorithms for 10x+ speedup</span>
<span class="sd">4. Integration with existing MD framework</span>

<span class="sd">References:</span>
<span class="sd">- Still et al., J. Am. Chem. Soc. 112, 6127 (1990) - Original GB model</span>
<span class="sd">- Onufriev et al., Proteins 55, 383 (2004) - GB-OBC model</span>
<span class="sd">- Srinivasan et al., Theor. Chem. Acc. 101, 426 (1999) - PBSA approach</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="GBModel">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.GBModel">[docs]</a>
<span class="k">class</span> <span class="nc">GBModel</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Different Generalized Born model variants.&quot;&quot;&quot;</span>
    <span class="n">GB_HCT</span> <span class="o">=</span> <span class="s2">&quot;GB-HCT&quot;</span>  <span class="c1"># Hawkins-Cramer-Truhlar</span>
    <span class="n">GB_OBC1</span> <span class="o">=</span> <span class="s2">&quot;GB-OBC1&quot;</span>  <span class="c1"># Onufriev-Bashford-Case I</span>
    <span class="n">GB_OBC2</span> <span class="o">=</span> <span class="s2">&quot;GB-OBC2&quot;</span>  <span class="c1"># Onufriev-Bashford-Case II</span>
    <span class="n">GB_NECK</span> <span class="o">=</span> <span class="s2">&quot;GB-Neck&quot;</span>  <span class="c1"># Neck correction model</span></div>


<div class="viewcode-block" id="SAModel">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.SAModel">[docs]</a>
<span class="k">class</span> <span class="nc">SAModel</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Surface area calculation methods.&quot;&quot;&quot;</span>
    <span class="n">LCPO</span> <span class="o">=</span> <span class="s2">&quot;LCPO&quot;</span>  <span class="c1"># Linear Combination of Pairwise Overlaps</span>
    <span class="n">ICOSA</span> <span class="o">=</span> <span class="s2">&quot;ICOSA&quot;</span>  <span class="c1"># Icosahedral integration</span>
    <span class="n">GAUSS</span> <span class="o">=</span> <span class="s2">&quot;GAUSS&quot;</span>  <span class="c1"># Gaussian integration</span></div>


<div class="viewcode-block" id="AtomGBParameters">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.AtomGBParameters">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AtomGBParameters</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GB parameters for individual atoms.&quot;&quot;&quot;</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Born radius (nm)</span>
    <span class="n">screen</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Screening parameter</span>
    <span class="n">charge</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Partial charge (e)</span>
    <span class="n">surface_tension</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Surface tension coefficient (kJ/mol/nm²)</span></div>


<div class="viewcode-block" id="GBSAParameters">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.GBSAParameters">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">GBSAParameters</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Global GBSA model parameters.&quot;&quot;&quot;</span>
    <span class="n">interior_dielectric</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Interior dielectric constant</span>
    <span class="n">solvent_dielectric</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">78.5</span>  <span class="c1"># Water dielectric constant</span>
    <span class="n">ionic_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Salt concentration (M)</span>
    <span class="n">surface_tension</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0072</span>  <span class="c1"># Global surface tension (kJ/mol/nm²)</span>
    <span class="n">cut_off</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># Cutoff for GB interactions (nm)</span>
    <span class="n">probe_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.14</span>  <span class="c1"># Solvent probe radius (nm)</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.009</span>  <span class="c1"># Surface area offset (kJ/mol/nm²)</span></div>


<div class="viewcode-block" id="GeneralizedBornModel">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.GeneralizedBornModel">[docs]</a>
<span class="k">class</span> <span class="nc">GeneralizedBornModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generalized Born model for electrostatic solvation.</span>
<span class="sd">    </span>
<span class="sd">    The GB model approximates the electrostatic solvation free energy</span>
<span class="sd">    by treating the solute as a low-dielectric cavity in a high-dielectric</span>
<span class="sd">    continuum solvent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="GeneralizedBornModel.__init__">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.GeneralizedBornModel.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_type</span><span class="p">:</span> <span class="n">GBModel</span> <span class="o">=</span> <span class="n">GBModel</span><span class="o">.</span><span class="n">GB_OBC2</span><span class="p">,</span> 
                 <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GBSAParameters</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Generalized Born model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_type : GBModel</span>
<span class="sd">            Type of GB model to use</span>
<span class="sd">        parameters : GBSAParameters, optional</span>
<span class="sd">            Model parameters. Uses defaults if None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">model_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span> <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">GBSAParameters</span><span class="p">()</span>
        
        <span class="c1"># Model-specific constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_model_constants</span><span class="p">()</span>
        
        <span class="c1"># Cached data for efficiency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_born_radii</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pairwise_gb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_positions</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> model&quot;</span><span class="p">)</span></div>

    
    <span class="k">def</span> <span class="nf">_init_model_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize model-specific constants.&quot;&quot;&quot;</span>
        <span class="c1"># Coulomb constant in kJ·nm·mol⁻¹·e⁻²</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coulomb_constant</span> <span class="o">=</span> <span class="mf">138.935458</span>
        
        <span class="c1"># Model-specific parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">GBModel</span><span class="o">.</span><span class="n">GB_HCT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="mf">0.8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">4.85</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">GBModel</span><span class="o">.</span><span class="n">GB_OBC1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">2.909125</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">GBModel</span><span class="o">.</span><span class="n">GB_OBC2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="mf">0.8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">4.85</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">GBModel</span><span class="o">.</span><span class="n">GB_NECK</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="mf">0.8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">4.85</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neck_scale</span> <span class="o">=</span> <span class="mf">0.826</span>
    
<div class="viewcode-block" id="GeneralizedBornModel.calculate_born_radii">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.GeneralizedBornModel.calculate_born_radii">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_born_radii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                           <span class="n">atom_radii</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate effective Born radii for all atoms.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        positions : np.ndarray</span>
<span class="sd">            Atomic positions with shape (n_atoms, 3) in nm</span>
<span class="sd">        atom_radii : np.ndarray</span>
<span class="sd">            Intrinsic atomic radii with shape (n_atoms,) in nm</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Effective Born radii with shape (n_atoms,) in nm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">born_radii</span> <span class="o">=</span> <span class="n">atom_radii</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Calculate pairwise distances</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_distances</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        
        <span class="c1"># Apply Born radius reduction based on neighboring atoms</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">):</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="mf">0.0</span>
            
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="n">r_ij</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">r_j</span> <span class="o">=</span> <span class="n">atom_radii</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">r_i</span> <span class="o">=</span> <span class="n">atom_radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                
                <span class="c1"># Skip if beyond cutoff</span>
                <span class="k">if</span> <span class="n">r_ij</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cut_off</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Calculate overlapping sphere integral</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">GBModel</span><span class="o">.</span><span class="n">GB_HCT</span><span class="p">,</span> <span class="n">GBModel</span><span class="o">.</span><span class="n">GB_OBC1</span><span class="p">,</span> <span class="n">GBModel</span><span class="o">.</span><span class="n">GB_OBC2</span><span class="p">]:</span>
                    <span class="n">integral</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_overlap_integral_obc</span><span class="p">(</span><span class="n">r_ij</span><span class="p">,</span> <span class="n">r_i</span><span class="p">,</span> <span class="n">r_j</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">GBModel</span><span class="o">.</span><span class="n">GB_NECK</span><span class="p">:</span>
                    <span class="n">integral</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_overlap_integral_neck</span><span class="p">(</span><span class="n">r_ij</span><span class="p">,</span> <span class="n">r_i</span><span class="p">,</span> <span class="n">r_j</span><span class="p">)</span>
            
            <span class="c1"># Update Born radius</span>
            <span class="k">if</span> <span class="n">integral</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">GBModel</span><span class="o">.</span><span class="n">GB_OBC2</span><span class="p">:</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">integral</span> <span class="o">*</span> <span class="n">r_i</span>
                    <span class="n">psi2</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">psi</span>
                    <span class="n">psi3</span> <span class="o">=</span> <span class="n">psi2</span> <span class="o">*</span> <span class="n">psi</span>
                    <span class="n">born_radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">r_i</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="o">*</span><span class="n">psi</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">*</span><span class="n">psi2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="o">*</span><span class="n">psi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">r_i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">born_radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">r_i</span> <span class="o">-</span> <span class="n">integral</span><span class="p">)</span>
                
                <span class="c1"># Ensure Born radius doesn&#39;t become negative or too small</span>
                <span class="n">born_radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">born_radii</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">r_i</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_born_radii</span> <span class="o">=</span> <span class="n">born_radii</span>
        <span class="k">return</span> <span class="n">born_radii</span></div>

    
    <span class="k">def</span> <span class="nf">_calculate_overlap_integral_obc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_ij</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_i</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_j</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate overlap integral for OBC models.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">r_ij</span> <span class="o">&gt;=</span> <span class="n">r_i</span> <span class="o">+</span> <span class="n">r_j</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="k">if</span> <span class="n">r_ij</span> <span class="o">&lt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r_i</span> <span class="o">-</span> <span class="n">r_j</span><span class="p">):</span>
            <span class="c1"># Complete overlap</span>
            <span class="k">if</span> <span class="n">r_j</span> <span class="o">&gt;</span> <span class="n">r_i</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">r_i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="c1"># Partial overlap</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_ij</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">r_j</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">r_ij</span> <span class="o">*</span> <span class="n">r_i</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">temp</span><span class="p">))</span>  <span class="c1"># Clamp to [-1, 1]</span>
        
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">integral</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">r_i</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">r_j</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">r_ij</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">integral</span>
    
    <span class="k">def</span> <span class="nf">_calculate_overlap_integral_neck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_ij</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_i</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_j</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate overlap integral with neck correction.&quot;&quot;&quot;</span>
        <span class="n">base_integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_overlap_integral_obc</span><span class="p">(</span><span class="n">r_ij</span><span class="p">,</span> <span class="n">r_i</span><span class="p">,</span> <span class="n">r_j</span><span class="p">)</span>
        
        <span class="c1"># Add neck correction</span>
        <span class="k">if</span> <span class="n">r_ij</span> <span class="o">&lt;</span> <span class="n">r_i</span> <span class="o">+</span> <span class="n">r_j</span> <span class="ow">and</span> <span class="n">r_ij</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r_i</span> <span class="o">-</span> <span class="n">r_j</span><span class="p">):</span>
            <span class="n">neck_factor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">neck_scale</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_ij</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">r_i</span> <span class="o">*</span> <span class="n">r_j</span><span class="p">))</span>
            <span class="n">base_integral</span> <span class="o">*=</span> <span class="n">neck_factor</span>
        
        <span class="k">return</span> <span class="n">base_integral</span>
    
<div class="viewcode-block" id="GeneralizedBornModel.calculate_gb_energy_and_forces">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.GeneralizedBornModel.calculate_gb_energy_and_forces">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_gb_energy_and_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                     <span class="n">charges</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                     <span class="n">born_radii</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate Generalized Born solvation energy and forces.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        positions : np.ndarray</span>
<span class="sd">            Atomic positions with shape (n_atoms, 3) in nm</span>
<span class="sd">        charges : np.ndarray</span>
<span class="sd">            Atomic charges with shape (n_atoms,) in e</span>
<span class="sd">        born_radii : np.ndarray</span>
<span class="sd">            Born radii with shape (n_atoms,) in nm</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (solvation_energy, forces) where energy is in kJ/mol</span>
<span class="sd">            and forces have shape (n_atoms, 3) in kJ/mol/nm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="c1"># Dielectric factor</span>
        <span class="n">dielectric_factor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">interior_dielectric</span> <span class="o">-</span> 
                           <span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">solvent_dielectric</span><span class="p">)</span>
        
        <span class="c1"># Self energy terms</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">):</span>
            <span class="n">q_i</span> <span class="o">=</span> <span class="n">charges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">R_i</span> <span class="o">=</span> <span class="n">born_radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
            <span class="n">self_energy</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coulomb_constant</span> <span class="o">*</span> <span class="n">dielectric_factor</span> <span class="o">*</span> <span class="n">q_i</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">R_i</span>
            <span class="n">energy</span> <span class="o">+=</span> <span class="n">self_energy</span>
        
        <span class="c1"># Pairwise interaction terms</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_distances</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_atoms</span><span class="p">):</span>
                <span class="n">r_ij</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                
                <span class="c1"># Skip if beyond cutoff</span>
                <span class="k">if</span> <span class="n">r_ij</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cut_off</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="n">q_i</span><span class="p">,</span> <span class="n">q_j</span> <span class="o">=</span> <span class="n">charges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">charges</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">R_i</span><span class="p">,</span> <span class="n">R_j</span> <span class="o">=</span> <span class="n">born_radii</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">born_radii</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                
                <span class="c1"># GB interaction energy</span>
                <span class="n">f_GB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">r_ij</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">R_i</span> <span class="o">*</span> <span class="n">R_j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_ij</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">R_i</span> <span class="o">*</span> <span class="n">R_j</span><span class="p">)))</span>
                <span class="n">pair_energy</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">coulomb_constant</span> <span class="o">*</span> <span class="n">dielectric_factor</span> <span class="o">*</span> <span class="n">q_i</span> <span class="o">*</span> <span class="n">q_j</span> <span class="o">/</span> <span class="n">f_GB</span>
                <span class="n">energy</span> <span class="o">+=</span> <span class="n">pair_energy</span>
                
                <span class="c1"># Forces (simplified - full derivatives are complex)</span>
                <span class="n">r_vec</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">r_ij</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">force_magnitude</span> <span class="o">=</span> <span class="n">pair_energy</span> <span class="o">*</span> <span class="n">r_ij</span> <span class="o">/</span> <span class="p">(</span><span class="n">f_GB</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">r_ij</span><span class="p">)</span>
                    <span class="n">force_vec</span> <span class="o">=</span> <span class="n">force_magnitude</span> <span class="o">*</span> <span class="n">r_vec</span>
                    
                    <span class="n">forces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">force_vec</span>
                    <span class="n">forces</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">force_vec</span>
        
        <span class="k">return</span> <span class="n">energy</span><span class="p">,</span> <span class="n">forces</span></div>

    
    <span class="k">def</span> <span class="nf">_calculate_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate pairwise distances between atoms.&quot;&quot;&quot;</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_atoms</span><span class="p">,</span> <span class="n">n_atoms</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_atoms</span><span class="p">):</span>
                <span class="n">r_ij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_ij</span>
                <span class="n">distances</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_ij</span>
        
        <span class="k">return</span> <span class="n">distances</span></div>


<div class="viewcode-block" id="SurfaceAreaModel">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.SurfaceAreaModel">[docs]</a>
<span class="k">class</span> <span class="nc">SurfaceAreaModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Surface area calculation for hydrophobic interactions.</span>
<span class="sd">    </span>
<span class="sd">    The SA term accounts for the hydrophobic effect by calculating</span>
<span class="sd">    the solvent-accessible surface area and applying surface tension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="SurfaceAreaModel.__init__">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.SurfaceAreaModel.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_type</span><span class="p">:</span> <span class="n">SAModel</span> <span class="o">=</span> <span class="n">SAModel</span><span class="o">.</span><span class="n">LCPO</span><span class="p">,</span>
                 <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GBSAParameters</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Surface Area model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_type : SAModel</span>
<span class="sd">            Type of SA calculation method</span>
<span class="sd">        parameters : GBSAParameters, optional</span>
<span class="sd">            Model parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">model_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span> <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">GBSAParameters</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> surface area model&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="SurfaceAreaModel.calculate_surface_area_and_forces">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.SurfaceAreaModel.calculate_surface_area_and_forces">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_surface_area_and_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                        <span class="n">radii</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                        <span class="n">surface_tensions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate surface area energy and forces.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        positions : np.ndarray</span>
<span class="sd">            Atomic positions with shape (n_atoms, 3) in nm</span>
<span class="sd">        radii : np.ndarray</span>
<span class="sd">            Atomic radii with shape (n_atoms,) in nm</span>
<span class="sd">        surface_tensions : np.ndarray</span>
<span class="sd">            Surface tension coefficients with shape (n_atoms,) in kJ/mol/nm²</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (surface_energy, forces) where energy is in kJ/mol</span>
<span class="sd">            and forces have shape (n_atoms, 3) in kJ/mol/nm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">SAModel</span><span class="o">.</span><span class="n">LCPO</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_lcpo_surface_area</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">surface_tensions</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">SAModel</span><span class="o">.</span><span class="n">ICOSA</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_icosa_surface_area</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">surface_tensions</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_gauss_surface_area</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">surface_tensions</span><span class="p">)</span></div>

    
    <span class="k">def</span> <span class="nf">_calculate_lcpo_surface_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                   <span class="n">radii</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                   <span class="n">surface_tensions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate surface area using Linear Combination of Pairwise Overlaps.&quot;&quot;&quot;</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">total_energy</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="c1"># Expand radii by probe radius</span>
        <span class="n">expanded_radii</span> <span class="o">=</span> <span class="n">radii</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">probe_radius</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">):</span>
            <span class="c1"># Start with full sphere surface area</span>
            <span class="n">area_i</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">expanded_radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            
            <span class="c1"># Subtract overlaps with other atoms</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="n">r_ij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">r_i</span> <span class="o">=</span> <span class="n">expanded_radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">r_j</span> <span class="o">=</span> <span class="n">expanded_radii</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                
                <span class="c1"># Calculate overlap area</span>
                <span class="n">overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_sphere_overlap</span><span class="p">(</span><span class="n">r_ij</span><span class="p">,</span> <span class="n">r_i</span><span class="p">,</span> <span class="n">r_j</span><span class="p">)</span>
                <span class="n">area_i</span> <span class="o">-=</span> <span class="n">overlap</span>
            
            <span class="c1"># Ensure area is non-negative</span>
            <span class="n">area_i</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">area_i</span><span class="p">)</span>
            
            <span class="c1"># Calculate energy contribution</span>
            <span class="n">energy_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">surface_tensions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">area_i</span>
            <span class="n">total_energy</span> <span class="o">+=</span> <span class="n">energy_i</span>
            
            <span class="c1"># Calculate forces (simplified)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="n">r_vec</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">r_ij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r_vec</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">r_ij</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">r_ij</span> <span class="o">&lt;</span> <span class="n">expanded_radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">expanded_radii</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="c1"># Force due to surface area change</span>
                    <span class="n">force_magnitude</span> <span class="o">=</span> <span class="n">surface_tensions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">expanded_radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">force_vec</span> <span class="o">=</span> <span class="n">force_magnitude</span> <span class="o">*</span> <span class="n">r_vec</span> <span class="o">/</span> <span class="n">r_ij</span>
                    
                    <span class="n">forces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">force_vec</span>
                    <span class="n">forces</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">force_vec</span>
        
        <span class="k">return</span> <span class="n">total_energy</span><span class="p">,</span> <span class="n">forces</span>
    
    <span class="k">def</span> <span class="nf">_calculate_sphere_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_ij</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_i</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_j</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate overlapping surface area between two spheres.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">r_ij</span> <span class="o">&gt;=</span> <span class="n">r_i</span> <span class="o">+</span> <span class="n">r_j</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>  <span class="c1"># No overlap</span>
        
        <span class="k">if</span> <span class="n">r_ij</span> <span class="o">&lt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r_i</span> <span class="o">-</span> <span class="n">r_j</span><span class="p">):</span>
            <span class="c1"># Complete overlap - smaller sphere is inside larger</span>
            <span class="k">if</span> <span class="n">r_i</span> <span class="o">&lt;=</span> <span class="n">r_j</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r_i</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># Full surface of smaller sphere</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>  <span class="c1"># Larger sphere loses no area</span>
        
        <span class="c1"># Partial overlap</span>
        <span class="c1"># Calculate cap height for sphere i</span>
        <span class="n">h_i</span> <span class="o">=</span> <span class="n">r_i</span> <span class="o">-</span> <span class="p">(</span><span class="n">r_ij</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">r_j</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">r_i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">r_ij</span><span class="p">)</span>
        
        <span class="c1"># Cap area</span>
        <span class="n">cap_area</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r_i</span> <span class="o">*</span> <span class="n">h_i</span>
        
        <span class="k">return</span> <span class="n">cap_area</span>
    
    <span class="k">def</span> <span class="nf">_calculate_icosa_surface_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                    <span class="n">radii</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                    <span class="n">surface_tensions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate surface area using icosahedral integration (simplified).&quot;&quot;&quot;</span>
        <span class="c1"># This is a simplified implementation - full icosahedral method is complex</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_lcpo_surface_area</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">surface_tensions</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_calculate_gauss_surface_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                    <span class="n">radii</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                    <span class="n">surface_tensions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate surface area using Gaussian integration (simplified).&quot;&quot;&quot;</span>
        <span class="c1"># This is a simplified implementation - full Gaussian method is complex</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_lcpo_surface_area</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">surface_tensions</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImplicitSolventModel">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.ImplicitSolventModel">[docs]</a>
<span class="k">class</span> <span class="nc">ImplicitSolventModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete Generalized Born/Surface Area (GB/SA) implicit solvent model.</span>
<span class="sd">    </span>
<span class="sd">    This class combines the GB electrostatic model with the SA hydrophobic</span>
<span class="sd">    model to provide a complete implicit solvation treatment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="ImplicitSolventModel.__init__">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.ImplicitSolventModel.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">gb_model</span><span class="p">:</span> <span class="n">GBModel</span> <span class="o">=</span> <span class="n">GBModel</span><span class="o">.</span><span class="n">GB_OBC2</span><span class="p">,</span>
                 <span class="n">sa_model</span><span class="p">:</span> <span class="n">SAModel</span> <span class="o">=</span> <span class="n">SAModel</span><span class="o">.</span><span class="n">LCPO</span><span class="p">,</span>
                 <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GBSAParameters</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the implicit solvent model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gb_model : GBModel</span>
<span class="sd">            Generalized Born model variant</span>
<span class="sd">        sa_model : SAModel</span>
<span class="sd">            Surface area calculation method</span>
<span class="sd">        parameters : GBSAParameters, optional</span>
<span class="sd">            Model parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span> <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">GBSAParameters</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">gb_model</span> <span class="o">=</span> <span class="n">GeneralizedBornModel</span><span class="p">(</span><span class="n">gb_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sa_model</span> <span class="o">=</span> <span class="n">SurfaceAreaModel</span><span class="p">(</span><span class="n">sa_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        
        <span class="c1"># Atom-specific parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_default_parameters</span><span class="p">()</span>
        
        <span class="c1"># Performance tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculation_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized GB/SA implicit solvent model: </span><span class="si">{</span><span class="n">gb_model</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="n">sa_model</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
    <span class="k">def</span> <span class="nf">_setup_default_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup default GB/SA parameters for common atom types.&quot;&quot;&quot;</span>
        <span class="c1"># Standard amino acid atom radii (nm) and surface tensions (kJ/mol/nm²)</span>
        <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">AtomGBParameters</span><span class="p">(</span><span class="mf">0.17</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0072</span><span class="p">),</span>      <span class="c1"># Carbon</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">AtomGBParameters</span><span class="p">(</span><span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.68</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0072</span><span class="p">),</span>      <span class="c1"># Nitrogen  </span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="n">AtomGBParameters</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.68</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0072</span><span class="p">),</span>      <span class="c1"># Oxygen</span>
            <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">AtomGBParameters</span><span class="p">(</span><span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0072</span><span class="p">),</span>      <span class="c1"># Sulfur</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="n">AtomGBParameters</span><span class="p">(</span><span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0072</span><span class="p">),</span>      <span class="c1"># Hydrogen</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="n">AtomGBParameters</span><span class="p">(</span><span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.86</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0072</span><span class="p">),</span>      <span class="c1"># Phosphorus</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">default_parameters</span> <span class="o">=</span> <span class="n">default_params</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setup default parameters for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">default_params</span><span class="p">)</span><span class="si">}</span><span class="s2"> atom types&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="ImplicitSolventModel.set_atom_parameters">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.ImplicitSolventModel.set_atom_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">set_atom_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> 
                          <span class="n">atom_types</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                          <span class="n">charges</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                          <span class="n">custom_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AtomGBParameters</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set atom-specific parameters for the system.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atom_indices : list of int</span>
<span class="sd">            Atom indices in the system</span>
<span class="sd">        atom_types : list of str</span>
<span class="sd">            Atom type names (e.g., &#39;C&#39;, &#39;N&#39;, &#39;O&#39;)</span>
<span class="sd">        charges : list of float</span>
<span class="sd">            Partial charges in elementary units</span>
<span class="sd">        custom_params : dict, optional</span>
<span class="sd">            Custom parameters for specific atom types</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params_to_use</span> <span class="o">=</span> <span class="n">custom_params</span> <span class="k">if</span> <span class="n">custom_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_parameters</span>
        
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">charge</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_types</span><span class="p">,</span> <span class="n">charges</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">atom_type</span> <span class="ow">in</span> <span class="n">params_to_use</span><span class="p">:</span>
                <span class="c1"># Copy default parameters and set charge</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">AtomGBParameters</span><span class="p">(</span>
                    <span class="n">radius</span><span class="o">=</span><span class="n">params_to_use</span><span class="p">[</span><span class="n">atom_type</span><span class="p">]</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
                    <span class="n">screen</span><span class="o">=</span><span class="n">params_to_use</span><span class="p">[</span><span class="n">atom_type</span><span class="p">]</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span>
                    <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span>
                    <span class="n">surface_tension</span><span class="o">=</span><span class="n">params_to_use</span><span class="p">[</span><span class="n">atom_type</span><span class="p">]</span><span class="o">.</span><span class="n">surface_tension</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atom_parameters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No parameters found for atom type </span><span class="si">{</span><span class="n">atom_type</span><span class="si">}</span><span class="s2">, using carbon defaults&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atom_parameters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">AtomGBParameters</span><span class="p">(</span><span class="mf">0.17</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="mf">0.0072</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set parameters for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">)</span><span class="si">}</span><span class="s2"> atoms&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="ImplicitSolventModel.calculate_solvation_energy_and_forces">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.ImplicitSolventModel.calculate_solvation_energy_and_forces">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_solvation_energy_and_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate total implicit solvation energy and forces.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        positions : np.ndarray</span>
<span class="sd">            Atomic positions with shape (n_atoms, 3) in nm</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (total_energy, forces) where energy is in kJ/mol</span>
<span class="sd">            and forces have shape (n_atoms, 3) in kJ/mol/nm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        
        <span class="c1"># Extract parameters for all atoms</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">radius</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">)])</span>
        <span class="n">charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">)])</span>
        <span class="n">surface_tensions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">surface_tension</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">)])</span>
        
        <span class="c1"># Calculate Born radii</span>
        <span class="n">born_radii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gb_model</span><span class="o">.</span><span class="n">calculate_born_radii</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">radii</span><span class="p">)</span>
        
        <span class="c1"># Calculate GB energy and forces</span>
        <span class="n">gb_energy</span><span class="p">,</span> <span class="n">gb_forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gb_model</span><span class="o">.</span><span class="n">calculate_gb_energy_and_forces</span><span class="p">(</span>
            <span class="n">positions</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="n">born_radii</span><span class="p">)</span>
        
        <span class="c1"># Calculate SA energy and forces</span>
        <span class="n">sa_energy</span><span class="p">,</span> <span class="n">sa_forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sa_model</span><span class="o">.</span><span class="n">calculate_surface_area_and_forces</span><span class="p">(</span>
            <span class="n">positions</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">surface_tensions</span><span class="p">)</span>
        
        <span class="c1"># Combine results</span>
        <span class="n">total_energy</span> <span class="o">=</span> <span class="n">gb_energy</span> <span class="o">+</span> <span class="n">sa_energy</span>
        <span class="n">total_forces</span> <span class="o">=</span> <span class="n">gb_forces</span> <span class="o">+</span> <span class="n">sa_forces</span>
        
        <span class="c1"># Update performance tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculation_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_time</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        
        <span class="k">return</span> <span class="n">total_energy</span><span class="p">,</span> <span class="n">total_forces</span></div>

    
<div class="viewcode-block" id="ImplicitSolventModel.get_performance_stats">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.ImplicitSolventModel.get_performance_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">get_performance_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get performance statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculation_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;calculations&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;avg_time&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;total_time&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
        
        <span class="n">avg_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_time</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculation_count</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;calculations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculation_count</span><span class="p">,</span>
            <span class="s1">&#39;avg_time_ms&#39;</span><span class="p">:</span> <span class="n">avg_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s1">&#39;total_time_s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_time</span>
        <span class="p">}</span></div>

    
<div class="viewcode-block" id="ImplicitSolventModel.validate_speedup">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.ImplicitSolventModel.validate_speedup">[docs]</a>
    <span class="k">def</span> <span class="nf">validate_speedup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate computational speedup compared to explicit solvent.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        positions : np.ndarray</span>
<span class="sd">            Test positions</span>
<span class="sd">        n_repeats : int</span>
<span class="sd">            Number of calculations to average over</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Performance metrics</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">time</span>
        
        <span class="c1"># Time implicit solvent calculations</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">):</span>
            <span class="n">energy</span><span class="p">,</span> <span class="n">forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_solvation_energy_and_forces</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">implicit_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        
        <span class="c1"># Estimate explicit solvent time (typical scaling)</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">explicit_time_estimate</span> <span class="o">=</span> <span class="n">implicit_time</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_atoms</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span>  <span class="c1"># Rough estimate</span>
        
        <span class="n">speedup</span> <span class="o">=</span> <span class="n">explicit_time_estimate</span> <span class="o">/</span> <span class="n">implicit_time</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;implicit_time_s&#39;</span><span class="p">:</span> <span class="n">implicit_time</span><span class="p">,</span>
            <span class="s1">&#39;explicit_time_estimate_s&#39;</span><span class="p">:</span> <span class="n">explicit_time_estimate</span><span class="p">,</span>
            <span class="s1">&#39;speedup_factor&#39;</span><span class="p">:</span> <span class="n">speedup</span><span class="p">,</span>
            <span class="s1">&#39;calculations_per_second&#39;</span><span class="p">:</span> <span class="n">n_repeats</span> <span class="o">/</span> <span class="n">implicit_time</span>
        <span class="p">}</span></div>
</div>


<span class="c1"># Integration with force field system</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">..forcefield.forcefield</span> <span class="kn">import</span> <span class="n">ForceTerm</span>
    
    <span class="k">class</span> <span class="nc">ImplicitSolventForceTerm</span><span class="p">(</span><span class="n">ForceTerm</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Force term for implicit solvent in the MD force field framework.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
<div class="viewcode-block" id="ImplicitSolventForceTerm.__init__">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.ImplicitSolventForceTerm.__init__">[docs]</a>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">implicit_model</span><span class="p">:</span> <span class="n">ImplicitSolventModel</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Initialize implicit solvent force term.</span>
<span class="sd">            </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            implicit_model : ImplicitSolventModel</span>
<span class="sd">                Configured implicit solvent model</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">implicit_model</span> <span class="o">=</span> <span class="n">implicit_model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ImplicitSolvent&quot;</span></div>

        
<div class="viewcode-block" id="ImplicitSolventForceTerm.calculate">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.ImplicitSolventForceTerm.calculate">[docs]</a>
        <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                     <span class="n">box_vectors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate implicit solvent forces and energy.</span>
<span class="sd">            </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            positions : np.ndarray</span>
<span class="sd">                Particle positions with shape (n_particles, 3) in nm</span>
<span class="sd">            box_vectors : np.ndarray, optional</span>
<span class="sd">                Periodic box vectors (not used for implicit solvent)</span>
<span class="sd">                </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            tuple</span>
<span class="sd">                (forces, potential_energy) where forces have shape (n_particles, 3)</span>
<span class="sd">                in kJ/mol/nm and energy is in kJ/mol</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">energy</span><span class="p">,</span> <span class="n">forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicit_model</span><span class="o">.</span><span class="n">calculate_solvation_energy_and_forces</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">forces</span><span class="p">,</span> <span class="n">energy</span></div>

    
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not import ForceTerm base class - force field integration unavailable&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="ImplicitSolventForceTerm">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.ImplicitSolventForceTerm">[docs]</a>
    <span class="k">class</span> <span class="nc">ImplicitSolventForceTerm</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Placeholder when force field integration is not available.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="create_default_implicit_solvent">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.create_default_implicit_solvent">[docs]</a>
<span class="k">def</span> <span class="nf">create_default_implicit_solvent</span><span class="p">(</span><span class="n">atom_types</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                  <span class="n">charges</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                                  <span class="n">gb_model</span><span class="p">:</span> <span class="n">GBModel</span> <span class="o">=</span> <span class="n">GBModel</span><span class="o">.</span><span class="n">GB_OBC2</span><span class="p">,</span>
                                  <span class="n">sa_model</span><span class="p">:</span> <span class="n">SAModel</span> <span class="o">=</span> <span class="n">SAModel</span><span class="o">.</span><span class="n">LCPO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ImplicitSolventModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a default implicit solvent model for a protein system.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atom_types : list of str</span>
<span class="sd">        Atom type names for all atoms</span>
<span class="sd">    charges : list of float</span>
<span class="sd">        Partial charges for all atoms</span>
<span class="sd">    gb_model : GBModel</span>
<span class="sd">        GB model variant to use</span>
<span class="sd">    sa_model : SAModel</span>
<span class="sd">        SA model variant to use</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ImplicitSolventModel</span>
<span class="sd">        Configured implicit solvent model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ImplicitSolventModel</span><span class="p">(</span><span class="n">gb_model</span><span class="p">,</span> <span class="n">sa_model</span><span class="p">)</span>
    
    <span class="c1"># Set up atom parameters</span>
    <span class="n">atom_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atom_types</span><span class="p">)))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set_atom_parameters</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_types</span><span class="p">,</span> <span class="n">charges</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created default implicit solvent model for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">atom_types</span><span class="p">)</span><span class="si">}</span><span class="s2"> atoms&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="benchmark_implicit_vs_explicit">
<a class="viewcode-back" href="../../../api/environment.html#proteinMD.environment.implicit_solvent.benchmark_implicit_vs_explicit">[docs]</a>
<span class="k">def</span> <span class="nf">benchmark_implicit_vs_explicit</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Benchmark implicit solvent performance against explicit solvent expectations.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Benchmark results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create test system</span>
    <span class="n">n_atoms</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="mf">2.0</span>  <span class="c1"># 2x2x2 nm box</span>
    <span class="n">atom_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_atoms</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_atoms</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="mf">0.25</span>  <span class="c1"># Random charges</span>
    
    <span class="c1"># Create implicit solvent model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_default_implicit_solvent</span><span class="p">(</span><span class="n">atom_types</span><span class="p">,</span> <span class="n">charges</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    
    <span class="c1"># Benchmark</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">validate_speedup</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">n_repeats</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Benchmark results: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;speedup_factor&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">x speedup&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Run basic validation</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Implicit Solvent Model Validation&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    
    <span class="c1"># Create test system</span>
    <span class="n">n_atoms</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.5</span>
    <span class="n">atom_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_atoms</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_atoms</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">charges</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_atoms</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_atoms</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span>
    
    <span class="c1"># Test different models</span>
    <span class="k">for</span> <span class="n">gb_model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">GBModel</span><span class="o">.</span><span class="n">GB_HCT</span><span class="p">,</span> <span class="n">GBModel</span><span class="o">.</span><span class="n">GB_OBC2</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">sa_model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SAModel</span><span class="o">.</span><span class="n">LCPO</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Testing </span><span class="si">{</span><span class="n">gb_model</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="n">sa_model</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">model</span> <span class="o">=</span> <span class="n">create_default_implicit_solvent</span><span class="p">(</span><span class="n">atom_types</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="n">gb_model</span><span class="p">,</span> <span class="n">sa_model</span><span class="p">)</span>
            <span class="n">energy</span><span class="p">,</span> <span class="n">forces</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calculate_solvation_energy_and_forces</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Solvation energy: </span><span class="si">{</span><span class="n">energy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> kJ/mol&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max force: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">forces</span><span class="p">))</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> kJ/mol/nm&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Force RMS: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">forces</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> kJ/mol/nm&quot;</span><span class="p">)</span>
    
    <span class="c1"># Performance benchmark</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performance Benchmark:&quot;</span><span class="p">)</span>
    <span class="n">benchmark_results</span> <span class="o">=</span> <span class="n">benchmark_implicit_vs_explicit</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Speedup factor: </span><span class="si">{</span><span class="n">benchmark_results</span><span class="p">[</span><span class="s1">&#39;speedup_factor&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Calculations/second: </span><span class="si">{</span><span class="n">benchmark_results</span><span class="p">[</span><span class="s1">&#39;calculations_per_second&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">✓ Implicit solvent model validation completed!&quot;</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">ProteinMD</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/cli_reference.html">CLI Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/core.html">Core Simulation Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/structure.html">Structure Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/forcefield.html">Force Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/environment.html">Environment Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/analysis.html">Analysis Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/sampling.html">Sampling Methods API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/visualization.html">Visualization Tools API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cli.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/utils.html">Utilities API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, ProteinMD Development Team.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>